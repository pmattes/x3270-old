<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="GENERATOR" content="Mozilla/4.5 [en] (WinNT; U) [Netscape]">
   <title>Scripting Facilies for x3270 and s3270</title>
</head>
<body>

<h1>
Scripting Facilities for x3270 and s3270</h1>

<h2>
SYNOPSIS</h2>
<b>x3270 -script</b> [<i>x3270-options</i>]
<p><b>s3270</b> [<i>s3270-options</i>]
<p><b>Script(</b><i>command</i>[<i>,arg</i>...]<b>)</b>
<h2>
DESCRIPTION</h2>
The <b>x3270</b> scripting facilities allow <b>x3270</b> and <b>s3270</b>
to be operated under the control of another program.
<p>There are two basic methods. The first is the <b>peer script</b> facility,
invoked by the
<b>x3270 -script</b> switch (<b>s3270</b> functions exclusively
in script mode). This runs <b>x3270</b> or <b>s3270</b> as a child of another
process. Typically this would be a script using <i>expect</i>(1) or the
co-process facility of the Korn Shell <i>ksh</i>(1). When the <b>-script</b>
switch is given, <b>x3270</b> looks for commands on its standard input,
and places the responses on standard output and standard error output.
<p>The second method is the <b>child script</b> facility, invoked by the
<b>Script()</b>
action. This runs a script as a child process of <b>x3270</b> or <b>s3270</b>.
The child has access to pipes connected to <b>x3270</b> or <b>s3270</b>;
<b>x3270</b> or <b>s3270</b> look for commands on one pipe, and places
the responses on the other. (The file descriptor of the pipe for commands
to <b>x3270</b> or <b>s3270</b> is passed in the environment variable X3270INPUT;
the file descriptor of the pipe for responses from <b>x3270</b> or <b>s3270</b>
is passed in the environment variable X3270OUTPUT.)
<p>(It is possible to mix the two methods: A script can invoke another
script with the <b>Script()</b> action. Scripts may also be implicitly
nested when a script invokes the
<b>Connect()</b> action, and the <b>ibm_hosts</b>
file specifies a login script for that host name.)
<p>Commands are X actions; the syntax is the same as for the right-hand
side of an X translation table (an <b>x3270</b> keymap), with two exceptions:
only one action may appear per line, and if no parameters are needed by
the action, the parentheses may be omitted.
<p>Any <b>x3270</b> or <b>s3270</b> action may be specified. Several new
actions have been defined for use by scripts, and the behavior of certain
other actions (and of <b>x3270</b> in general) is different when an action
is initiated by a script.
<p>Some actions generate output; some may delay completion until the certain
external events occur, such as the host unlocking the keyboard. The completion
of every command is marked by a two-line message. The first line is the
current status of <b>x3270</b> or <b>s3270</b>, documented below. If the
command is successful, the second line is the string "ok"; otherwise it
is the string "error".
<h2>
STATUS FORMAT</h2>
The status message consists of 12 blank-separated fields:
<dl>
<dt>
Keyboard State</dt>

<dd>
If the keyboard is unlocked, the letter <b>U</b>. If the keyboard is locked
waiting for a response from the host, or if not connected to a host, the
letter <b>L</b>. If the keyboard is locked because of an operator error
(field overflow, protected field, etc.), the letter <b>E</b>.</dd>

<dt>
Screen Formatting</dt>

<dd>
If the screen is formatted, the letter <b>F</b>. If unformatted or in ANSI
mode, the letter <b>U</b>.</dd>

<dt>
Field Protection</dt>

<dd>
If the field containing the cursor is protected, the letter <b>P</b>. If
unprotected or unformatted, the letter <b>U</b>.</dd>

<dt>
Connection State</dt>

<dd>
If connected to a host, the string <b>C(</b><i>hostname).</i> Otherwise,
the letter <b>N</b>.</dd>

<dt>
Emulator Mode</dt>

<dd>
If connected in 3270 mode, the letter <b>I</b>. If connected in ANSI line
mode, the letter <b>L</b>. If connected in ANSI character mode, the letter
<b>C</b>. If not connected, the letter <b>N</b>.</dd>

<dt>
Model Number (2-5)</dt>

<dt>
Number of Rows</dt>

<dd>
The current number of rows defined on the screen. The host can request
that <b>x3270</b> or <b>s3270</b> use a 24x80 screen, so this number may
be smaller than the maximum number of rows possible with the current model.</dd>

<dt>
Number of Columns</dt>

<dd>
The current number of columns defined on the screen, subject to the same
difference for rows, above.</dd>

<dt>
Cursor Row</dt>

<dd>
The current cursor row (zero-origin).</dd>

<dt>
Cursor Column</dt>

<dd>
The current cursor column (zero-origin).</dd>

<dt>
Window ID</dt>

<dd>
The X window identifier for the main
<b>x3270</b> window, in hexadecimal
preceded by
<b>0x</b>. For <b>s3270</b>, this is zero.</dd>
</dl>

<h2>
DIFFERENCES</h2>
When an action is initiated by a script, <b>x3270</b> behaves in several
different ways:
<p>If an error occurs, the usual pop-up window does not appear. Instead,
the text is written to standard error output.
<p>If end-of-file is detected on standard input, <b>x3270</b> exits. (A
script can exit without killing <b>x3270</b> by using the <b>CloseScript()</b>
action, below.) Note that this applies to peer scripts only; end-of-file
on the pipe connected to a child script simply causes the pipes to be closed
and the <b>Script()</b> action to complete.
<p>The <b>Quit()</b> action always causes <b>x3270</b> to exit. (When called
from the keyboard, it will exit only if not connected to a host.)
<p>The <b>Clear()</b>, <b>Enter()</b>, <b>PF()</b>, and <b>PA()</b> actions
will not complete until the host unlocks the keyboard. If the parameter
to a <b>String()</b> action includes a code for one these actions, it will
also wait for the keyboard to unlock before completing. Similarly, the
<b>Script()</b> action does not complete until end-of-file is detected
on the pipe or the <b>CloseScript()</b> action is called by the child process.
<h2>
NEW ACTIONS</h2>
The following actions have been defined or modified for use with scripts.
(Note that unlike the status line display, the <i>row</i> and <i>col</i>
coordinates used in these actions use [0,0] as their origin, not [1,1]).
<dl>
<dt>
<b>AnsiText()</b></dt>

<dd>
Outputs whatever data that has been output by the host in ANSI mode since
the last time that <b>AnsiText()</b> was called. The data is preceded by
the string <tt>data:</tt>, and has had all control characters expanded
into C backslash sequences.</dd>

<p><br>This is a convenient way to capture ANSI mode output in a synchronous
manner without trying to decode the screen contents.
<dt>
<b>Ascii(</b><i>row</i>, <i>col</i>, <i>rows</i>, <i>cols</i><b>)</b></dt>

<br><b>Ascii(</b><i>row</i>, <i>col</i>, <i>len</i><b>)</b>
<br><b>Ascii(</b><i>len</i><b>)</b>
<br><b>Ascii()</b>
<dd>
Outputs an ASCII text representation of the screen contents. Each line
is preceded by the string <tt>data:</tt>, and there are no control characters.</dd>

<p><br>If all four parameters are given, a rectangular region of the screen
is output.
<p>If three parameters are given, <i>len</i> characters are output, starting
at the specified row and column.
<p>If only the <i>len</i> parameter is given, that many characters are
output, starting at the cursor position.
<p>If no parameters are given, the entire screen is output.
<dt>
<b>AsciiField()</b></dt>

<dd>
Outputs an ASCII text representation of the field containing the cursor.
The text is preceded by the string <tt>data:</tt>.</dd>

<dt>
<b>Connect(</b><i>hostname</i><b>)</b></dt>

<dd>
Connects to a host. The action does not return until
<b>x3270</b> or <b>s3270</b>
is successfully connected in the proper mode, or the connection fails.</dd>

<dt>
<b>CloseScript(</b><i>status</i><b>)</b></dt>

<dd>
Causes <b>x3270</b> to stop reading commands from the script. This is useful
to allow a peer script to exit, with
<b>x3270</b> proceeding interactively.
(Without this action, <b>x3270</b> would exit when it detected end-of-file
on standard input.) If the script was invoked by the <b>Script()</b> action,
the optional
<i>status</i> is used as the return status of <b>Script()</b>;
if nonzero,
<b>Script()</b> will complete with an error, and if this script
was invoked as part of login through the <b>ibm_hosts</b> file, the connection
will be broken.</dd>

<dt>
<b>ContinueScript(</b><i>param</i><b>)</b></dt>

<dd>
Allows a script that is waiting in a <b>PauseScript()</b> action, below,
to continue. The <i>param</i> given is output by the <b>PauseScript()</b>
action.</dd>

<dt>
<b>Disconnect()</b></dt>

<dd>
Disconnects from the host.</dd>

<dt>
<b>Ebcdic(</b><i>row</i>, <i>col</i>, <i>rows</i>, <i>cols</i><b>)</b></dt>

<br><b>Ebcdic(</b><i>row</i>, <i>col</i>, <i>len</i><b>)</b>
<br><b>Ebcdic(</b><i>len</i><b>)</b>
<br><b>Ebcdic()</b>
<dd>
The same function as <b>Ascii()</b> above, except that rather than generating
ASCII text, each character is output as a hexadecimal EBCDIC code, preceded
by
<b>0x</b>.</dd>

<dt>
<b>EbcdicField()</b></dt>

<dd>
The same function as <b>AsciiField()</b> above, except that it generates
hexadecimal EBCDIC codes.</dd>

<dt>
<b>Expect(</b><i>text</i><b>)</b></dt>

<br><b>Expect(</b><i>text</i>, <i>timeout</i><b>)</b>
<dd>
Pauses the script until the specified <i>text</i> appears in the data stream
from the host, or the specified <i>timeout</i> (in seconds) expires. If
no <i>timeout</i> is specified, the default is 30 seconds.
<i>Text</i>
can contain standard C-language escape (backslash) sequences. No wild-card
characters or pattern anchor characters are understood.
<b>Expect()</b>
is valid only in ANSI mode.</dd>

<dt>
<b>Info(</b><i>message</i><b>)</b></dt>

<dd>
Pops up an informational message.</dd>

<dt>
<b>MoveCursor(</b><i>row</i>, <i>col</i><b>)</b></dt>

<dd>
Moves the cursor to the specified coordinates.</dd>

<dt>
<b>PauseScript()</b></dt>

<dd>
Stops a script until the <b>ContinueScript()</b> action, above, is executed.
This allows a script to wait for user input and continue. Outputs the single
parameter to <b>ContinueScript()</b>.</dd>

<dt>
<b>Transfer(</b><i>keyword=value</i>,...<b>)</b></dt>

<dd>
Invokes IND$FILE file transfer. Note that this action requires that the
IND$FILE program be installed on the IBM host, and that the 3270 cursor
be located in a field that will accept a TSO or VM/CMS command.</dd>

<dd>
</dd>

<dd>
Because of the complexity and number of options for file transfer, the
parameters to the <b>Transfer </b>action take the unique form of <i>option</i>=<i>value</i>,
and can appear in any order. The options are:</dd>

<dl>
<pre>Option&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Required?&nbsp;&nbsp; Default&nbsp;&nbsp; Other Values
------------------------------------------------------------------
Direction&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; No&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; send&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; receive
HostFile&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Yes
LocalFile&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Yes
Host&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; No&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tso&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vm
Mode&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; No&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ascii&nbsp;&nbsp;&nbsp;&nbsp; binary
Cr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; No&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; remove&nbsp;&nbsp;&nbsp; add, keep
Exist&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; No&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; keep&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; replace, append
Recfm&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; No&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fixed, variable, undefined
Lrecl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; No
Blksize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; No
Allocation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; No&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tracks, cylinders, avblock
PrimarySpace&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; No
SecondarySpace&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; No</pre>
</dl>

<dd>
The option details are as follows.</dd>

<dl>
<dt>
<b>Direction</b></dt>

<dd>
<b>send</b> (the default) to send a file to the host, <b>receive</b> to
receive a file from the host.</dd>

<dt>
<b>HostFile</b></dt>

<dd>
The name of the file on the host.</dd>

<dt>
<b>LocalFile</b></dt>

<dd>
The name of the file on the local workstation.</dd>

<dt>
<b>Host</b></dt>

<dd>
The type of host (which dictates the form of the IND$FILE command): <b>tso</b>
(the default) or <b>vm</b>.</dd>

<dt>
<b>Mode</b></dt>

<dd>
Use <b>ascii</b> (the default) for a text file, which will be translated
between EBCDIC and ASCII as necessary. Use <b>binary</b> for non-text files.</dd>

<dt>
<b>Cr</b></dt>

<dd>
Controls how Newline characters are handled when transferring <b>Mode=ascii</b>
files. <b>remove </b>(the default) strips Newline characters in local files
before transferring them to the host. <b>add</b> adds Newline characters
to each host file record before transferring it to the local workstation.
<b>keep</b> preserves Newline characters when transferring a local file
to the host.</dd>

<dt>
<b>Exist</b></dt>

<dd>
Controls what happens when the destination file already exists. <b>keep</b>
(the default) preserves the file, causing the <b>Transfer</b> action to
fail. <b>replace</b> overwrites the destination file with the source file.
<b>append</b> appends the source file to the destination file.</dd>

<dt>
<b>Recfm</b></dt>

<dd>
Controls the record format of files created on the host. <b>fixed</b> creates
a file with fixed-length records. <b>variable</b> creates a file with variable-length
records. <b>undefined</b> creates a file with undefined-length records
(TSO hosts only). The <b>Lrecl</b> option controls the record length or
maximum record length for <b>Recfm=fixed</b> and <b>Recfm=variable</b>
files, respectively.</dd>

<dt>
<b>Lrecl</b></dt>

<dd>
Specifies the record length (or maximum record length) for files created
on the host.</dd>

<dt>
<b>Blksize</b></dt>

<dd>
Specifies the block size for files created on the host. (TSO hosts only.)</dd>

<dt>
<b>Allocation</b></dt>

<dd>
Specifies the units for the TSO host <b>PrimarySpace</b> and <b>SecondarySpace</b>
options: <b>tracks</b>, <b>cylinders</b> or <b>avblock</b>.</dd>

<dt>
<b>PrimarySpace</b></dt>

<dd>
Primary allocation for a file created on a TSO host. The units are given
by the <b>Allocation</b> option.</dd>

<dt>
<b>SecondarySpace</b></dt>

<dd>
Secondary allocation for a file created on a TSO host. The units are given
by the <b>Allocation</b> option.</dd>
</dl>

<dt>
<b>Wait()</b></dt>

<dd>
A useful utility for use at the beginning of scripts and after the
<b>Connect()</b>
action. In 3270 mode, waits until the screen is formatted, and the host
has positioned the cursor on a modifiable field. In ANSI mode, waits until
the host sends at least one byte of data.</dd>

<dt>
<b>Wait(3270)</b></dt>

<dd>
Used when communicating with a host that switches between ANSI mode and
3270 mode. Pauses the script or macro until the host negotiates 3270 mode,
then waits for a formatted screen as above.</dd>

<dt>
<b>Wait(ansi)</b></dt>

<dd>
Used when communicating with a host that switches between 3270 mode and
ANSI mode. Pauses the script or macro until the host negotiates ANSI mode,
then waits for a byte from the host as above.</dd>
</dl>

<h2>
SEE ALSO</h2>
<i>expect</i>(1)
<br><i>ksh(1)</i>
<br><a href="x3270-man.html"><i>x3270</i>(1)</a>
<br><a href="s3270-man.html"><i>s3270</i>(1)</a>
<hr>
<address>
Last modified 1. June 2000</address>

</body>
</html>
